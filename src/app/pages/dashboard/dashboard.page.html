<ion-content class="ion-padding dashboard-container" scrollEvents="true">
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <div class="header-left">
          <img src="assets/logo.png" alt="Agnivolt Logo" class="logo">
          <div class="header-title-wrapper">
            <h1>Sistem Monitoring PLTMH Berbasis IoT</h1>
            <div class="system-status">
              <span class="status-indicator"></span>
              <span class="status-text">Sistem Online</span>
            </div>
          </div>
        </div>

        <div class="header-right">
          <div class="user-info" (click)="toggleProfileMenu()">
            <div class="user-details">
              <span class="greeting">Halo,</span>
              <span class="user-name">{{ userName }}</span>
            </div>
            <div class="user-avatar-header">{{ userInitial }}</div>
            <ion-icon name="chevron-down-outline" class="dropdown-icon" [class.rotated]="showProfileMenu"></ion-icon>
          </div>

          <!-- Dropdown Menu -->
          <div class="profile-dropdown" *ngIf="showProfileMenu">
            <div class="dropdown-item" (click)="openProfile()">
              <ion-icon name="person-outline"></ion-icon>
              <span>Profil Saya</span>
            </div>
            <div class="dropdown-item" (click)="openSettings()">
              <ion-icon name="settings-outline"></ion-icon>
              <span>Pengaturan</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item logout" (click)="logout()">
              <ion-icon name="log-out-outline"></ion-icon>
              <span>Keluar</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Cards -->
    <div class="status-bar">
      <div class="status-card voltage">
        <div class="status-info">
          <h3>Tegangan</h3>
          <div class="status-value" id="voltage">0</div>
          <div class="status-unit">Volt</div>
        </div>
      </div>
      <div class="status-card current">
        <div class="status-info">
          <h3>Arus Listrik</h3>
          <div class="status-value" id="current">0</div>
          <div class="status-unit">Ampere</div>
        </div>
      </div>
      <div class="status-card power">
        <div class="status-info">
          <h3>Daya</h3>
          <div class="status-value" id="power">0</div>
          <div class="status-unit">Watt</div>
        </div>
      </div>
      <div class="status-card rpm">
        <div class="status-info">
          <h3>Kecepatan Turbin</h3>
          <div class="status-value" id="rpm">0</div>
          <div class="status-unit">RPM</div>
        </div>
      </div>
    </div>

    <!-- Chart + Summary -->
    <div class="grid">
      <div class="chart-container">
        <div class="chart-tabs">
          <button class="tab-button active" (click)="switchChart('realtime', $event)">Real-time</button>
          <button class="tab-button" (click)="switchChart('daily', $event)">Harian</button>
          <button class="tab-button" (click)="switchChart('weekly', $event)">Mingguan</button>
        </div>
        <h2>{{ chartTitle }}</h2>
        <canvas id="realtimeChart"></canvas>
      </div>

      <div class="summary-cards">
        <div class="summary-card">
          <h3>Durasi Penggunaan Hari Ini</h3>
          <div class="summary-value" id="duration">0</div>
          <div class="status-unit">Jam</div>
        </div>
        <div class="summary-card">
          <h3>Total Daya Dihasilkan</h3>
          <div class="summary-value" id="totalPower">0</div>
          <div class="status-unit">kWh</div>
        </div>
        <div class="summary-card">
          <h3>Efisiensi</h3>
          <div class="summary-value" id="efficiency">0</div>
          <div class="status-unit">%</div>
        </div>
      </div>
    </div>

    <!-- FAB AI Assistant -->
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button color="primary" (click)="openAiAssistant()" class="ai-fab">
        <ion-icon name="chatbubbles-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </div>

  <footer class="footer">
    <p>Â© 2025 Agnivolt â€¢ Sistem Monitoring PLTMH Berbasis IoT</p>
  </footer>

  <!-- AI Assistant Overlay -->
  <div *ngIf="showAiAssistant" class="ai-overlay">
    <!-- Backdrop -->
    <div class="ai-backdrop" (click)="closeAiAssistant()"></div>

    <!-- Sidebar Panel -->
    <div class="ai-sidebar">
      <!-- Header Sidebar -->
      <div class="sidebar-header">
        <div class="sidebar-title">
          <ion-icon name="chatbubbles" class="header-icon"></ion-icon>
          <h2>AI Assistant</h2>
        </div>
        <ion-button fill="clear" class="close-btn" (click)="closeAiAssistant()">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </div>

      <!-- Chat Messages Area -->
      <div class="chat-messages" #chatMessages>
        <div
          *ngFor="let msg of aiMessages"
          class="message-row"
          [ngClass]="msg.sender"
        >
          <div class="message-avatar">{{ msg.avatar }}</div>
          <div class="message-bubble" [innerHTML]="msg.text"></div>
        </div>

        <!-- Loading -->
        <div *ngIf="isAiLoading" class="message-row ai">
          <div class="message-avatar">ðŸ¤–</div>
          <div class="message-bubble">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input Footer -->
      <div class="chat-footer">
        <div class="chat-input-wrapper">
          <ion-input
            [(ngModel)]="chatInput"
            placeholder="Tanyakan tentang PLTMH..."
            (keyup.enter)="sendAiMessage()"
            class="chat-input"
          ></ion-input>
          <ion-button
            (click)="sendAiMessage()"
            fill="clear"
            class="send-btn"
            [disabled]="!chatInput.trim()"
          >
            <ion-icon name="send"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>
  </div>
</ion-content>